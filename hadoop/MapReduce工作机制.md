# MapReduce工作机制
![MapTask](../pictures/mapreduce1.png)
![ReduceTask](../pictures/mapreduce2.png)

# 1.shuffle流程
## 1.map处理后的数据写入环形缓冲区
### 1.1环形缓冲区
![环形缓冲区](../pictures/环形缓冲区.png)
```txt
    1.环形缓冲区默认大小为100M
    2.分为两块,一块索引区,一块数据区
    索引区:
        index:对应数据在索引区的索引
        partition:对应数据的分区
        keystart:对应数据的key
        valstart:对应数据的值的起始点
    数据区:
        key,val   
```
### 1.2环形缓冲区的工作原理
```txt
map处理后的数据先正向写入环形缓冲区,在数据区或索引区到达80%占用时
    1.对这些数据进行分区且排序,然后溢出到文件写入磁盘(分区且区内有序,但是在同一个溢出文件中),排序方式为快速排序
    2.同时在缓冲区内map写入的数据从剩余的20%开始反向写入,当写入碰到写出时,睡眠等待写出
多个溢出文件,合并,归并排序为一个大的溢出文件    
```

### 1.3可选流程combiner
```txt
    将每一个mapTask的溢出文件提前进行归并排序从(a,1)(a,1)(a,1)(b,1)的形式
变成(a,3)(b,1)的形式,默认合并10个文件,最后将所有的文件合并成一个(a,3)(b,1)的形式的大文件,可选压缩,写入磁盘
```

### 1.4reduceTask复制
```txt
reduceTask从各个mapTask处把分区数据复制回来,读取在内存中,如果内存不够溢出到磁盘,根据对应的分区做归并排序,然后按照key分组,发送给reduce方法
```

# 2.shuffle总结
```txt
```
