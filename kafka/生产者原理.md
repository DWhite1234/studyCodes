# 生产者原理
## 1.分区策略
1.分区的原因
    (1):方便拓展集群
    (2):提高并发

2.分区的原则
    (1):指定partition 
    (2):不指定partition 但是有key,会通过key的hash值与topic的partition 数进行取模发送到相应的分区
    (3):既没有partition 也没有key,采用粘性分区器.
        先随机选择一个分区,然后一直使用该分区,知道该分区的这一批数据 (batch)满,然后再换下一个分区继续,类似轮询机制


## 2.数据可靠性保证
1.producer-->partition
为保证producer发送的数据，能可靠的发送到指定的topic，topic的每个partition收到producer发送的数据后，都需要向producer发送ack（acknowledgement确认收到），如果producer收到ack，就会进行下一轮的发送，否则重新发送数据

2.何时发送ack
当leader和所有的follow都完成落盘时,partition给producer返回ack

问题:如果有的follow在这个过程中宕机如何解决
引入:ISR
leader维护了一个动态ISR,在ISR中的才被视为健康的节点,在ISR中的规定时间内可以完成同步数据的才可以留下来,不能完成的则会被踢出ISR,这样就保证了所有的follow都完成同步,同时如果leader发生故障,会在ISR中排在第一位的被选为新的leader

时间由参数replica.lag.time.max.ms设置

3.ack应答等级
0:当leader内存接收到数据时就返回ack,延迟低,但是可能导致数据丢失
1:当leader落盘成功后返回ack,follow同步成功之前,leader故障会丢失数据
-1:partition的leader和follower全部落盘成功后才返回ack。但是如果在follower同步完成后，leader发送ack之前，leader发生故障，那么会造成数据重复

4.leader和follow故障处理细节
LEO：指的是每个副本最大的offset；
HW：指的是消费者能见到的最大的offset，ISR队列中最小的LEO。

    1.每个副本都会维护自己的LEO
    2.当follow故障后,会被踢出ISR
    3.当leader故障后,会在ISR中重新选出新的leader,此时所有的副本都会向HW看齐,截去比HW多的部分,producer重新发送这一批次的消息,然后由leader用HW要求producer重新从HW位置开始同步数据

## 3.Exactly Once(精准一致性)
ack=-1  At Least Once  
ack=0   At Most Once
在0.11版本后引入的幂等性这一特性
所谓的幂等性就是指Producer不论向Server发送多少次重复数据，Server端都只会持久化一条。也就是去重

At Least Once + 幂等性 = Exactly Once

要启用幂等性，只需要将Producer的参数中enable.idempotence设置为true即可(默认了)

开启幂等性的Producer在初始化的时候会被分配一个PID，发往同一Partition的消息会附带Sequence Number。而Broker端会对<PID, Partition, SeqNumber>做缓存，当具有相同主键的消息提交时，Broker只会持久化一条。
但是PID重启就会变化，同时不同的Partition也具有不同主键，所以幂等性无法保证跨分区跨会话的Exactly Once。
